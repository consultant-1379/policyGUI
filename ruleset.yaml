# Docker Registry for SD project.
docker:
  registry: armdocker.rnd.ericsson.se/proj-orchestration-sd-assurance

ruleset:
  # Build Docker container for a project.
  # Uses `Dockerfile` provided in the project root.
  # Overrides docker image name.
  - docker:
      env:
        - DOCKER_IMAGE_NAME: ${DOCKER_REGISTRY}/policygui

  # Build Helm chart for a project.
  # `helm-target` directory will be used used as work build directory.
  # Uses chart defined in `charts/` directory.
  # HELM_VALUES overrides variables inside `values.yaml` in chart: update version.
  - helm:
      env:
        - HELM_DESTINATION_FOLDER: 'helm-target'
        - HELM_REPO: https://arm.epk.ericsson.se/artifactory/proj-sd-assurance-service-helm/policygui
        - HELM_REPO_API_TOKEN: AKCp5aUZo58UnuDZdbLjhPDsWyc5kfDWY5tsTmSJdqtFUrrPepZ427ZUsD6woKg49uUiE4jxB
        - HELM_REPO_INDEX: false
        - HELM_VALUES: >-
            image:repository=${DOCKER_REGISTRY}/policygui
            image:tag=$(project::get_version ${RELEASE:-})

  # Generate properties for usage later in ADP pipeline.
  - adp.artifacts:
      env:
        - CHART_NAME: policygui
        - CHART_VERSION: $(project::get_version ${RELEASE:-})
        - CHART_REPO: https://arm.epk.ericsson.se/artifactory/proj-sd-assurance-service-helm
        - IMAGE_NAME: policygui
        - IMAGE_TAG: $(project::get_version ${RELEASE:-})
        - IMAGE_REPO: ${DOCKER_REGISTRY}

# Remove files generated by build process.
rule:
  clean:
    execute: |
      rm -f adp-cicd-goals.properties && \
      rm -f artifact.properties && \
      rm -rf helm-target
      rm -rf root/eso-commonlib/target  && \
      rm -rf root/node_modules/target && \
      rm -rf root/sap-decision-rules/target  && \
      rm -rf root/sap-execution-log/target  && \
      rm -rf root/sap-login/target  && \
      rm -rf root/sap-logout/target  && \
      rm -rf root/target
  build:
    execute:
      docker build -f Dockerfileuisdkbuilder -t ui-sdk-builder .
  run:
    execute:
      docker run --rm -v `pwd`:`pwd` -w `pwd`/root/scripts ui-sdk-builder /bin/bash -c "chmod +x buildMe.sh; ./buildMe.sh"
